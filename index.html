<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Quinta Era do Éter - Sistema de Fichas</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-darker: #1a1a1a;
            --bg-panel: #121212;
            --accent-color: #7c3aed;
            --accent-secondary: #f59e0b;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --edit-border: #4b5563;
            --disabled-text: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }

        /* Estilos compartilhados */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo h1 {
            color: var(--accent-color);
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Cinzel', serif;
        }

        .logo span {
            color: var(--accent-secondary);
            font-weight: 600;
            font-family: 'Cinzel', serif;
        }

        .action-btn {
            background-color: var(--bg-darker);
            color: var(--accent-color);
            border: 1px solid var(--edit-border);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            font-family: 'Roboto', sans-serif;
        }

        .action-btn:hover {
            border-color: var(--accent-color);
        }

        .action-btn.primary {
            background-color: var(--accent-color);
            color: white;
        }

        .action-btn.primary:hover {
            background-color: #6d28d9;
        }

        .search-bar {
            display: flex;
            margin-bottom: 20px;
        }

        .search-bar input {
            flex: 1;
            background: var(--bg-darker);
            border: 1px solid var(--edit-border);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 4px 0 0 4px;
            font-family: 'Roboto', sans-serif;
        }

        .search-bar button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }

        /* Estilos do Hub */
        .hub-view {
            display: none;
        }

        .sheet-view {
            display: none;
        }

        .sheets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 20px;
        }

        .sheet-card {
            background-color: var(--bg-panel);
            border-radius: 6px;
            padding: 15px;
            border: 1px solid var(--border-border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .sheet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .sheet-title {
            font-size: 1.2rem;
            color: var(--accent-color);
            font-family: 'Cinzel', serif;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sheet-player {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .sheet-resources {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .resource {
            flex: 1;
        }

        .resource-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .resource-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .resource-controls input {
            width: 100px;
            background: var(--bg-darker);
            border: 1px solid var(--edit-border);
            color: var(--text-primary);
            padding: 3px 5px;
            border-radius: 4px;
            text-align: center;
        }

        .resource-controls button {
            background: var(--bg-darker);
            border: 1px solid var(--edit-border);
            color: var(--text-primary);
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .resource-controls button:hover {
            border-color: var(--accent-color);
        }

        .progress-container {
            width: 100%;
            background-color: var(--bg-darker);
            border-radius: 4px;
            height: 20px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--accent-color), #9f7aea);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 0.7rem;
            color: white;
            transition: width 0.3s ease;
        }

        .sheet-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .sheet-btn {
            flex: 1;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            text-align: center;
            transition: all 0.2s;
        }

        .edit-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
        }

        .edit-btn:hover {
            background-color: #6d28d9;
        }

        .delete-btn {
            background-color: var(--bg-darker);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        .delete-btn:hover {
            background-color: rgba(239, 68, 68, 0.1);
        }

        /* Botão de atualização único */
        .update-all-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .update-all-btn:hover {
            background-color: #6d28d9;
        }

        /* Estilos da Ficha */
        .character-info {
            display: flex;
            gap: 15px;
            background-color: var(--bg-panel);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            border: 1px solid var(--border-color);
        }

        .character-info-item {
            flex: 1;
            min-width: 120px;
        }

        .character-info-item.small {
            flex: 0 0 auto;
            width: 100px;
        }

        .character-info-item h3 {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 5px;
            font-family: 'Cinzel', serif;
        }

        .character-info-item input {
            font-size: 0.9rem;
            width: 100%;
            background: var(--bg-darker);
            border: 1px solid var(--edit-border);
            color: var(--text-primary);
            padding: 6px 8px;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
        }

        .character-info-item input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2);
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            align-items: start;
        }

        .grid-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 100px;
        }

        .panel {
            background-color: var(--bg-panel);
            border-radius: 6px;
            padding: 15px;
            border: 1px solid var(--border-color);
            margin-bottom: 0;
            cursor: grab;
            user-select: none;
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }

        .panel.dragging {
            opacity: 0.8;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            cursor: grabbing;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-header h2 {
            color: var(--accent-color);
            font-size: 1.1rem;
            font-family: 'Cinzel', serif;
        }

        .panel-header .drag-handle {
            cursor: grab;
            padding: 5px;
            color: var(--text-secondary);
            display: none;
        }

        .panel-header .drag-handle:active {
            cursor: grabbing;
        }

        .panel-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
            overflow: auto;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .stat-name {
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: 'Cinzel', serif;
        }

        .stat-value {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-input {
            font-weight: bold;
            font-size: 0.9rem;
            padding: 6px;
            background-color: var(--bg-darker);
            border: 1px solid var(--edit-border);
            color: var(--text-primary);
            width: 70px;
            text-align: center;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
        }

        .stat-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .stat-calc {
            font-size: 0.8rem;
            color: var(--accent-secondary);
            min-width: 35px;
            text-align: center;
            font-family: 'Roboto', sans-serif;
        }

        .resource-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .resource-input {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .resource-input input {
            width: 70px;
            padding: 5px;
            background: var(--bg-darker);
            border: 1px solid var(--edit-border);
            color: var(--text-primary);
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
        }

        .resource-btn {
            padding: 5px 8px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-size: 0.8rem;
            background-color: var(--bg-darker);
            border: 1px solid var(--edit-border);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .resource-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .reduce-btn {
            color: var(--danger-color);
        }

        .reduce-btn:hover {
            border-color: var(--danger-color);
        }

        .add-btn {
            color: var(--success-color);
        }

        .add-btn:hover {
            border-color: var(--success-color);
        }

        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 8px;
        }

        .skill-item {
            background-color: var(--bg-darker);
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid var(--accent-secondary);
        }

        .skill-name {
            font-size: 0.8rem;
            margin-bottom: 4px;
            color: var(--text-primary);
            font-family: 'Cinzel', serif;
        }

        .skill-value, .editable {
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 3px;
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
            border: 1px solid var(--edit-border);
            width: 100%;
            font-family: 'Roboto', sans-serif;
        }

        .skill-value:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .abilities-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ability-item {
            background-color: var(--bg-darker);
            padding: 12px;
            border-radius: 4px;
            border-left: 4px solid var(--accent-color);
            position: relative;
            transition: all 0.3s ease;
        }

        .ability-item.collapsed {
            padding-bottom: 12px;
        }

        .ability-item.collapsed .ability-desc,
        .ability-item.collapsed .ability-meta {
            display: none;
        }

        .ability-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .ability-name {
            font-weight: bold;
            color: var(--accent-secondary);
            font-size: 0.95rem;
            flex: 1;
            min-width: 150px;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ability-name-input {
            background: transparent;
            border: none;
            color: var(--accent-secondary);
            font-weight: bold;
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            flex: 1;
            min-width: 150px;
            padding: 0;
        }

        .ability-name-input:focus {
            outline: none;
            border-bottom: 1px solid var(--accent-color);
        }

        .ability-cost {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .ability-cost span {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: 'Roboto', sans-serif;
        }

        .ability-cost input {
            background: var(--bg-dark);
            border: 1px solid var(--edit-border);
            color: var(--text-primary);
            padding: 3px 6px;
            border-radius: 4px;
            width: 50px;
            text-align: center;
            font-family: 'Roboto', sans-serif;
            font-size: 0.8rem;
        }

        .ability-cost input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .ability-desc {
            font-size: 0.85rem;
            color: var(--text-primary);
            line-height: 1.5;
            margin-bottom: 5px;
            width: 100%;
            background: var(--bg-darker);
            border: 1px solid var(--edit-border);
            padding: 8px;
            border-radius: 4px;
            min-height: 80px;
            font-family: 'Roboto', sans-serif;
            resize: vertical;
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) var(--bg-dark);
        }

        .ability-desc::-webkit-scrollbar {
            width: 8px;
        }

        .ability-desc::-webkit-scrollbar-track {
            background: var(--bg-dark);
            border-radius: 4px;
        }

        .ability-desc::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 4px;
        }

        .ability-desc:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .ability-meta {
            display: flex;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .ability-meta select,
        .ability-meta input {
            background: var(--bg-dark);
            border: 1px solid var(--edit-border);
            color: var(--text-primary);
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.8rem;
        }

        .ability-meta input {
            width: 100px;
        }

        .ability-meta select:focus,
        .ability-meta input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .ability-extra {
            font-size: 0.75rem;
            color: var(--disabled-text);
            margin-left: auto;
            margin-right: 30px;
            font-family: 'Roboto', sans-serif;
        }

        .ability-use-btn {
            background-color: var(--bg-darker);
            color: var(--success-color);
            border: 1px solid var(--edit-border);
            padding: 3px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-left: 8px;
            font-family: 'Roboto', sans-serif;
            transition: all 0.2s;
        }

        .ability-use-btn:hover {
            border-color: var(--success-color);
        }

        .ability-toggle {
            background-color: var(--bg-darker);
            color: var(--accent-color);
            border: 1px solid var(--edit-border);
            padding: 3px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-family: 'Roboto', sans-serif;
            transition: all 0.2s;
            user-select: none;
            pointer-events: none;
        }

        .ability-toggle:hover {
            border-color: var(--accent-color);
        }

        .weapons-table {
            width: 100%;
            border-collapse: collapse;
        }

        .weapons-table th {
            text-align: left;
            padding: 5px;
            background-color: var(--bg-darker);
            color: var(--text-secondary);
            font-weight: normal;
            border-bottom: 1px solid var(--border-color);
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
        }

        .weapons-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .weapons-table input {
            width: 100%;
            background: var(--bg-darker);
            border: 1px solid var(--edit-border);
            color: var(--text-primary);
            padding: 6px;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.8rem;
        }

        .weapons-table input.weapon-range,
        .weapons-table input.weapon-size {
            width: 50px;
            text-align: center;
        }

        .weapons-table input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .inventory-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .inventory-item {
            background-color: var(--bg-darker);
            padding: 12px;
            border-radius: 4px;
            border-left: 4px solid var(--accent-secondary);
            position: relative;
            transition: all 0.3s ease;
        }

        .inventory-item.collapsed {
            padding-bottom: 12px;
        }

        .inventory-item.collapsed .item-desc {
            display: none;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .item-name {
            font-weight: bold;
            color: var(--accent-secondary);
            font-size: 0.95rem;
            flex: 1;
            min-width: 150px;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item-meta {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .item-meta span {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: 'Roboto', sans-serif;
        }

        .item-meta input {
            background: var(--bg-dark);
            border: 1px solid var(--edit-border);
            color: var(--text-primary);
            padding: 3px 6px;
            border-radius: 4px;
            width: 50px;
            text-align: center;
            font-family: 'Roboto', sans-serif;
            font-size: 0.8rem;
        }

        .item-desc {
            font-size: 0.85rem;
            color: var(--text-primary);
            line-height: 1.5;
            margin-bottom: 5px;
            width: 100%;
            background: var(--bg-darker);
            border: 1px solid var(--edit-border);
            padding: 8px;
            border-radius: 4px;
            min-height: 60px;
            font-family: 'Roboto', sans-serif;
            resize: vertical;
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) var(--bg-dark);
        }

        .item-desc::-webkit-scrollbar {
            width: 8px;
        }

        .item-desc::-webkit-scrollbar-track {
            background: var(--bg-dark);
            border-radius: 4px;
        }

        .item-desc::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 4px;
        }

        .item-desc:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .item-toggle {
            background-color: var(--bg-darker);
            color: var(--accent-color);
            border: 1px solid var(--edit-border);
            padding: 3px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-family: 'Roboto', sans-serif;
            transition: all 0.2s;
            user-select: none;
            pointer-events: none;
        }

        .item-toggle:hover {
            border-color: var(--accent-color);
        }

        .back-btn {
            background-color: var(--bg-darker);
            color: var(--accent-color);
            border: 1px solid var(--edit-border);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            font-family: 'Roboto', sans-serif;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            border-color: var(--accent-color);
        }

        .delete-btn {
            background-color: var(--bg-darker);
            color: var(--danger-color);
            border: 1px solid var(--edit-border);
            padding: 3px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-family: 'Roboto', sans-serif;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            border-color: var(--danger-color);
        }

        .notes-content {
            min-height: 120px;
            background-color: var(--bg-darker);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            line-height: 1.5;
            border: 1px solid var(--edit-border);
            width: 100%;
            font-family: 'Roboto', sans-serif;
            resize: vertical;
            max-height: 300px;
            min-height: 120px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) var(--bg-dark);
        }

        .notes-content::-webkit-scrollbar {
            width: 8px;
        }

        .notes-content::-webkit-scrollbar-track {
            background: var(--bg-dark);
            border-radius: 4px;
        }

        .notes-content::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 4px;
        }

        .notes-content:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .drop-indicator {
            height: 3px;
            background-color: var(--accent-color);
            margin: 4px 0;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .drop-indicator.active {
            opacity: 1;
        }

        .panel-placeholder {
            border: 2px dashed var(--accent-color);
            background-color: rgba(124, 58, 237, 0.1);
            border-radius: 6px;
            margin: 4px 0;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--bg-panel);
            border-radius: 6px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: var(--accent-color);
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            background: var(--bg-darker);
            border: 1px solid var(--edit-border);
            color: var(--text-primary);
            padding: 8px 10px;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .player-select-section {
            width: 100%;
            margin-top: 15px;
        }

        .player-select-section label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .player-select-section select {
            width: 100%;
            background: var(--bg-darker);
            border: 1px solid var(--edit-border);
            color: var(--text-primary);
            padding: 8px 10px;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
            margin-bottom: 10px;
        }

        .player-select-section button {
            width: 100%;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1001;
        }

        .toast.show {
            opacity: 1;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sheets-grid {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }
        
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        
            .action-btn {
                flex: 1;
                text-align: center;
            }

            .character-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .character-info-item.small {
                width: 100%;
            }
            
            .ability-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .ability-cost {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <!-- Modal de senha global -->
<div class="modal" id="global-password-modal" style="display:flex;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Acesso ao Sistema</h2>
        </div>
        <div class="form-group">
            <label for="global-password-input">Senha:</label>
            <input type="password" id="global-password-input" placeholder="Digite a senha">
        </div>
        <div class="modal-actions">
            <button id="global-password-btn" class="action-btn primary">Entrar</button>
        </div>
        <div id="global-password-error" style="color:var(--danger-color);margin-top:10px;display:none;">Senha incorreta!</div>
    </div>
</div>

<!-- Modal de seleção de usuário -->
<div class="modal" id="user-select-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Selecione seu tipo de usuário</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-actions">
            <button id="select-master-btn" class="action-btn primary">Mestre</button>
            <div class="player-select-section">
                <label for="player-name-select">Jogador:</label>
                <select id="player-name-select"></select>
                <button id="select-player-btn" class="action-btn">Entrar como Jogador</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Login -->
<div class="modal" id="login-modal" style="display:flex;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Login</h2>
        </div>
        <div class="form-group">
            <label for="login-email">Email:</label>
            <input type="email" id="login-email" placeholder="Seu email">
        </div>
        <div class="form-group">
            <label for="login-password">Senha:</label>
            <input type="password" id="login-password" placeholder="Sua senha">
        </div>
        <div class="modal-actions">
            <button id="login-btn" class="action-btn primary">Entrar</button>
            <button id="register-btn" class="action-btn">Registrar</button>
        </div>
        <div id="login-error" style="color:var(--danger-color);margin-top:10px;display:none;"></div>
    </div>
</div>

    <!-- Hub de Fichas -->
    <div class="hub-view" id="hub-view">
        <div class="container">
            <header>
                <div class="logo">
                    <h1>A Quinta Era do Éter: <span>Hub de Fichas</span></h1>
                </div>
                <div class="header-actions">
                    <button id="new-sheet-btn" class="action-btn primary">+ Nova Ficha</button>
                    <button id="refresh-btn" class="action-btn">Atualizar</button>
                </div>
            </header>

            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Buscar fichas por nome, jogador...">
                <button id="search-btn">Buscar</button>
            </div>

            <div class="sheets-grid" id="sheets-container">
                <!-- Fichas serão carregadas aqui -->
            </div>
        </div>

        <!-- Modal para nova ficha -->
        <div class="modal" id="new-sheet-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Criar Nova Ficha</h2>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="form-group">
                    <label for="new-sheet-name">Nome do Personagem</label>
                    <input type="text" id="new-sheet-name" placeholder="Ex: Arthas Menethil">
                </div>
                <div class="form-group">
                    <label for="new-sheet-player">Jogador</label>
                    <input type="text" id="new-sheet-player" placeholder="Seu nome">
                </div>
                <div class="modal-actions">
                    <button id="cancel-sheet-btn" class="action-btn">Cancelar</button>
                    <button id="create-sheet-btn" class="action-btn primary">Criar Ficha</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Visualização da Ficha -->
    <div class="sheet-view" id="sheet-view">
        <div class="container">
            <button id="back-btn" class="back-btn">← Voltar ao Hub</button>

            <header>
                <div class="logo">
                    <h1>A Quinta Era do Éter: <span>Ficha de Personagem</span></h1>
                </div>
                <button id="toggle-edit" class="action-btn">Modo Reorganizar</button>
            </header>

            <div class="character-info">
                <div class="character-info-item">
                    <h3>PERSONAGEM</h3>
                    <input type="text" class="editable" id="character-name" placeholder="Nome do Personagem">
                </div>
                <div class="character-info-item">
                    <h3>JOGADOR</h3>
                    <input type="text" class="editable" id="player-name" placeholder="Nome do Jogador">
                </div>
                <div class="character-info-item">
                    <h3>DIVINDADE</h3>
                    <input type="text" class="editable" id="deity" placeholder="Divindade">
                </div>
                <div class="character-info-item small">
                    <h3>IDADE</h3>
                    <input type="text" class="editable" id="age" placeholder="Idade">
                </div>
                <div class="character-info-item small">
                    <h3>NÍVEL DE ÉTER</h3>
                    <input type="text" class="editable" id="ether-level" placeholder="Nível">
                </div>
                <div class="character-info-item small">
                    <h3>POTENCIAL</h3>
                    <input type="text" class="editable" id="potential" placeholder="Potencial">
                </div>
                <div class="character-info-item small">
                    <h3>DESPERTAR</h3>
                    <input type="text" class="editable" id="awakening" placeholder="Despertar">
                </div>
                <div class="character-info-item small">
                    <h3>ARMADURA</h3>
                    <input type="number" class="editable" id="armor" placeholder="0" value="0">
                </div>
            </div>

            <div class="main-grid">
                <!-- Coluna 1 -->
                <div class="grid-column" id="column-1">
                    <!-- Atributos -->
                    <div class="panel" data-panel-id="attributes">
                        <div class="panel-header">
                            <h2>ATRIBUTOS</h2>
                            <div class="drag-handle">☰</div>
                        </div>
                        <div class="panel-content">
                            <div class="stat-item">
                                <span class="stat-name">FORÇA</span>
                                <div class="stat-value">
                                    <input type="number" class="stat-input editable" id="strength" value="0">
                                    <span class="stat-calc" id="strength-calc"></span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">DESTREZA</span>
                                <div class="stat-value">
                                    <input type="number" class="stat-input editable" id="dexterity" value="0">
                                    <span class="stat-calc" id="dexterity-calc"></span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">CONSTITUIÇÃO</span>
                                <div class="stat-value">
                                    <input type="number" class="stat-input editable" id="constitution" value="0">
                                    <span class="stat-calc" id="constitution-calc"></span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">INTELIGÊNCIA</span>
                                <div class="stat-value">
                                    <input type="number" class="stat-input editable" id="intelligence" value="0">
                                    <span class="stat-calc" id="intelligence-calc"></span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">SABEDORIA</span>
                                <div class="stat-value">
                                    <input type="number" class="stat-input editable" id="wisdom" value="0">
                                    <span class="stat-calc" id="wisdom-calc"></span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">CARISMA</span>
                                <div class="stat-value">
                                    <input type="number" class="stat-input editable" id="charisma" value="0">
                                    <span class="stat-calc" id="charisma-calc"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vida -->
                    <div class="panel" data-panel-id="health">
                        <div class="panel-header">
                            <h2>VIDA</h2>
                            <div class="drag-handle">☰</div>
                        </div>
                        <div class="panel-content">
                            <div class="resource-controls">
                                <div class="resource-input">
                                    <input type="number" id="damage-input" placeholder="Dano">
                                    <button class="resource-btn reduce-btn" id="apply-damage-btn">Aplicar Dano</button>
                                </div>
                                <div class="resource-input">
                                    <input type="number" id="real-damage-input" placeholder="Dano Real">
                                    <button class="resource-btn reduce-btn" id="apply-real-damage-btn">Aplicar D. Real</button>
                                </div>
                            </div>
                            <div>
                                <div class="stat-item">
                                    <span class="stat-name">VIDA ATUAL</span>
                                    <div class="stat-value">
                                        <input type="number" class="stat-input editable" id="hp-current" value="0">
                                        <span>/</span>
                                        <input type="number" class="stat-input editable" id="hp-max" value="0">
                                    </div>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-bar" id="hp-bar" style="width: 0%">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Éter -->
                    <div class="panel" data-panel-id="ether">
                        <div class="panel-header">
                            <h2>ÉTER</h2>
                            <div class="drag-handle">☰</div>
                        </div>
                        <div class="panel-content">
                            <div class="resource-controls">
                                <div class="resource-input">
                                    <input type="number" id="ether-cost-input" placeholder="Valor">
                                    <button class="resource-btn reduce-btn" id="apply-ether-cost-btn">Reduzir</button>
                                    <button class="resource-btn add-btn" id="add-ether-btn">Adicionar</button>
                                </div>
                            </div>
                            <div>
                                <div class="stat-item">
                                    <span class="stat-name">ÉTER ATUAL</span>
                                    <div class="stat-value">
                                        <input type="number" class="stat-input editable" id="ether-current" value="0">
                                        <span>/</span>
                                        <input type="number" class="stat-input editable" id="ether-max" value="0">
                                    </div>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-bar" id="ether-bar" style="width: 0%">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Perícias -->
                    <div class="panel" data-panel-id="skills">
                        <div class="panel-header">
                            <h2>PERÍCIAS</h2>
                            <div class="drag-handle">☰</div>
                        </div>
                        <div class="panel-content">
                            <div class="skills-grid" id="skills-container">
                                <!-- Perícias serão adicionadas dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Coluna 2 -->
                <div class="grid-column" id="column-2">
                    <!-- Habilidades e Arcanas -->
                    <div class="panel" data-panel-id="abilities">
                        <div class="panel-header">
                            <h2>HABILIDADES & ARCANAS</h2>
                            <div class="drag-handle">☰</div>
                        </div>
                        <div class="panel-content">
                            <div class="abilities-list" id="abilities-container">
                                <!-- Habilidades serão adicionadas dinamicamente -->
                            </div>
                            <button class="action-btn" id="add-ability-btn">+ Adicionar Habilidade/Arcana</button>
                        </div>
                    </div>

                    <!-- Armamentos -->
                    <div class="panel" data-panel-id="weapons">
                        <div class="panel-header">
                            <h2>ARMAMENTOS</h2>
                            <div class="drag-handle">☰</div>
                        </div>
                        <div class="panel-content">
                            <table class="weapons-table" id="weapons-table">
                                <thead>
                                    <tr>
                                        <th>Arma</th>
                                        <th>Agir</th>
                                        <th>Dano</th>
                                        <th>Alcance</th>
                                        <th>Tamanho</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="weapons-body">
                                    <!-- Armas serão adicionadas dinamicamente -->
                                </tbody>
                            </table>
                            <button class="action-btn" id="add-weapon-btn">+ Adicionar Arma</button>
                        </div>
                    </div>

                    <!-- Anotações -->
                    <div class="panel" data-panel-id="notes">
                        <div class="panel-header">
                            <h2>ANOTAÇÕES</h2>
                            <div class="drag-handle">☰</div>
                        </div>
                        <div class="panel-content">
                            <textarea class="notes-content editable" id="notes" placeholder="Anotações sobre o personagem, história, eventos..."></textarea>
                        </div>
                    </div>

                    <!-- Inventário -->
                    <div class="panel" data-panel-id="inventory">
                        <div class="panel-header">
                            <h2>INVENTÁRIO</h2>
                            <div class="drag-handle">☰</div>
                        </div>
                        <div class="panel-content">
                            <div class="inventory-list" id="inventory-container">
                                <!-- Itens serão adicionados dinamicamente -->
                            </div>
                            <button class="action-btn" id="add-item-btn">+ Adicionar Item</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <script>
document.addEventListener('DOMContentLoaded', async function () {
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js");
    const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js");

    const firebaseConfig = {
        apiKey: "AIzaSyALPUrUbxV5WHjDLoev0iUTHYkj-EsaOX4",
        authDomain: "era-do-eter.firebaseapp.com",
        projectId: "era-do-eter",
        storageBucket: "era-do-eter.firebasestorage.app",
        messagingSenderId: "946835609657",
        appId: "1:946835609657:web:80c89d5bc95cf1694755e8",
        measurementId: "G-XRCPBXY5N4"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
        
    // Elementos do DOM
    const elements = {
        hubView: document.getElementById('hub-view'),
        sheetsContainer: document.getElementById('sheets-container'),
        newSheetBtn: document.getElementById('new-sheet-btn'),
        refreshBtn: document.getElementById('refresh-btn'),
        searchInput: document.getElementById('search-input'),
        searchBtn: document.getElementById('search-btn'),
        newSheetModal: document.getElementById('new-sheet-modal'),
        newSheetName: document.getElementById('new-sheet-name'),
        newSheetPlayer: document.getElementById('new-sheet-player'),
        createSheetBtn: document.getElementById('create-sheet-btn'),
        cancelSheetBtn: document.getElementById('cancel-sheet-btn'),
        sheetView: document.getElementById('sheet-view'),
        backBtn: document.getElementById('back-btn'),
        characterName: document.getElementById('character-name'),
        playerName: document.getElementById('player-name'),
        deity: document.getElementById('deity'),
        age: document.getElementById('age'),
        etherLevel: document.getElementById('ether-level'),
        potential: document.getElementById('potential'),
        awakening: document.getElementById('awakening'),
        armor: document.getElementById('armor'),
        strength: document.getElementById('strength'),
        dexterity: document.getElementById('dexterity'),
        constitution: document.getElementById('constitution'),
        intelligence: document.getElementById('intelligence'),
        wisdom: document.getElementById('wisdom'),
        charisma: document.getElementById('charisma'),
        hpCurrent: document.getElementById('hp-current'),
        hpMax: document.getElementById('hp-max'),
        etherCurrent: document.getElementById('ether-current'),
        etherMax: document.getElementById('ether-max'),
        hpBar: document.getElementById('hp-bar'),
        etherBar: document.getElementById('ether-bar'),
        skillsContainer: document.getElementById('skills-container'),
        abilitiesContainer: document.getElementById('abilities-container'),
        weaponsBody: document.getElementById('weapons-body'),
        inventoryContainer: document.getElementById('inventory-container'),
        notes: document.getElementById('notes'),
        addAbilityBtn: document.getElementById('add-ability-btn'),
        addWeaponBtn: document.getElementById('add-weapon-btn'),
        addItemBtn: document.getElementById('add-item-btn'),
        damageInput: document.getElementById('damage-input'),
        applyDamageBtn: document.getElementById('apply-damage-btn'),
        realDamageInput: document.getElementById('real-damage-input'),
        applyRealDamageBtn: document.getElementById('apply-real-damage-btn'),
        etherCostInput: document.getElementById('ether-cost-input'),
        applyEtherCostBtn: document.getElementById('apply-ether-cost-btn'),
        addEtherBtn: document.getElementById('add-ether-btn'),
        toggleEditBtn: document.getElementById('toggle-edit'),
        column1: document.getElementById('column-1'),
        column2: document.getElementById('column-2'),
        toast: document.getElementById('toast'),
        loginModal: document.getElementById('login-modal'),
        loginEmail: document.getElementById('login-email'),
        loginPassword: document.getElementById('login-password'),
        loginBtn: document.getElementById('login-btn'),
        registerBtn: document.getElementById('register-btn'),
        loginError: document.getElementById('login-error')
    };

    // Estado da aplicação
    const state = {
        sheets: [],
        currentSheetId: null,
        user: null,
        isMaster: false,
        refreshInterval: null
    };

    // Lista de perícias padrão
    const defaultSkills = [
        'Atirar', 'Correr', 'Combate', 'Armas', 'Ciências', 'Tecnologia',
        'Arcano', 'Procurar', 'Abrir Fechaduras', 'Reconhecer Armadilhas',
        'Escalar Muros', 'Mover-se Em Silêncio', 'Esconder-se nas Sombras',
        'Ouvir Barulhos', 'Ataque Pelas Costas', 'Presença'
    ];

    // Layout padrão dos painéis
    const defaultPanels = {
        'column-1': ['attributes', 'health', 'ether', 'skills'],
        'column-2': ['abilities', 'weapons', 'notes', 'inventory']
    };

    // Inicializar a aplicação
    function init() {
        showLoginModal();
        setupEventListeners();
    }

    // Mostrar modal de login
    function showLoginModal() {
        elements.loginModal.style.display = 'flex';
        elements.hubView.style.display = 'none';
        elements.sheetView.style.display = 'none';
        elements.loginError.style.display = 'none';
    }

    // Login
    elements.loginBtn.onclick = function() {
        const email = elements.loginEmail.value.trim();
        const password = elements.loginPassword.value.trim();
        if (!email || !password) {
            showLoginError('Preencha email e senha.');
            return;
        }
        firebase.auth().signInWithEmailAndPassword(email, password)
            .then(userCredential => {
                state.user = userCredential.user;
                elements.loginModal.style.display = 'none';
                checkMaster();
                loadSheets();
                showHub();
                startAutoRefresh();
            })
            .catch(err => showLoginError('Login falhou: ' + err.message));
    };

    // Registro
    elements.registerBtn.onclick = function() {
        const email = elements.loginEmail.value.trim();
        const password = elements.loginPassword.value.trim();
        if (!email || !password) {
            showLoginError('Preencha email e senha.');
            return;
        }
        firebase.auth().createUserWithEmailAndPassword(email, password)
            .then(userCredential => {
                state.user = userCredential.user;
                elements.loginModal.style.display = 'none';
                checkMaster();
                loadSheets();
                showHub();
                startAutoRefresh();
            })
            .catch(err => showLoginError('Registro falhou: ' + err.message));
    };

    function showLoginError(msg) {
        elements.loginError.textContent = msg;
        elements.loginError.style.display = 'block';
    }

    // Checa se usuário é mestre (email termina com @mestre.com)
    function checkMaster() {
        state.isMaster = state.user.email.endsWith('@mestre.com');
    }

    // Atualização automática
    function startAutoRefresh() {
        if (state.refreshInterval) clearInterval(state.refreshInterval);
        state.refreshInterval = setInterval(() => {
            if (elements.hubView.style.display === 'block') loadSheets();
        }, 5000);
    }

    // Carregar fichas do Firebase
    function loadSheets() {
        firebase.database().ref('sheets').once('value').then(snapshot => {
            const sheetsObj = snapshot.val() || {};
            state.sheets = Object.values(sheetsObj);
            renderSheets(elements.searchInput.value.trim());
        });
    }

    // Salvar fichas no Firebase
    function saveSheets() {
        const sheetsObj = {};
        state.sheets.forEach(sheet => sheetsObj[sheet.id] = sheet);
        firebase.database().ref('sheets').set(sheetsObj);
    }

    // Renderizar fichas no hub
    function renderSheets(filter = '') {
        elements.sheetsContainer.innerHTML = '';
        let sheetsToRender = state.sheets;

        // Jogador só vê sua ficha
        if (!state.isMaster) {
            sheetsToRender = sheetsToRender.filter(sheet => sheet.userId === state.user.uid);
        }

        // Filtro
        if (filter) {
            const searchTerm = filter.toLowerCase();
            sheetsToRender = sheetsToRender.filter(sheet =>
                (sheet.characterName || '').toLowerCase().includes(searchTerm) ||
                (sheet.playerName || '').toLowerCase().includes(searchTerm)
            );
        }

        sheetsToRender.sort((a, b) => (a.characterName || '').localeCompare(b.characterName || ''));

        if (sheetsToRender.length === 0) {
            elements.sheetsContainer.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-secondary)">
                    Nenhuma ficha encontrada.
                </div>
            `;
            return;
        }

        sheetsToRender.forEach(sheet => {
            const hpPercent = sheet.hpMax > 0 ? Math.min(100, (sheet.hpCurrent / sheet.hpMax * 100)).toFixed(1) : 0;
            const etherPercent = sheet.etherMax > 0 ? Math.min(100, (sheet.etherCurrent / sheet.etherMax * 100)).toFixed(1) : 0;
            const sheetCard = document.createElement('div');
            sheetCard.className = 'sheet-card';
            sheetCard.dataset.sheetId = sheet.id;
            sheetCard.innerHTML = `
                <div class="sheet-header">
                    <h3 class="sheet-title">
                        ${sheet.characterName || 'Sem nome'}
                        <span class="sheet-player">${sheet.playerName ? `(${sheet.playerName})` : ''}</span>
                    </h3>
                </div>
                <div class="sheet-resources">
                    <div class="resource">
                        <div class="resource-label">
                            <span>Vida</span>
                            <span>${sheet.hpCurrent || '0'}/${sheet.hpMax || '0'}</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${hpPercent}%">${hpPercent}%</div>
                        </div>
                    </div>
                    <div class="resource">
                        <div class="resource-label">
                            <span>Éter</span>
                            <span>${sheet.etherCurrent || '0'}/${sheet.etherMax || '0'}</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${etherPercent}%">${etherPercent}%</div>
                        </div>
                    </div>
                </div>
                <button class="update-all-btn" data-action="edit">Editar Ficha</button>
                ${state.isMaster ? `
                <div class="sheet-actions">
                    <button class="sheet-btn delete-btn" data-action="delete">Excluir</button>
                </div>
                ` : ''}
            `;
            elements.sheetsContainer.appendChild(sheetCard);
        });
    }

    // Criar nova ficha
    function createNewSheet() {
        const characterName = elements.newSheetName.value.trim();
        const playerName = elements.newSheetPlayer.value.trim();
        if (!characterName) {
            showToast('Por favor, insira um nome para o personagem');
            return;
        }
        const newSheet = {
            id: Date.now().toString(),
            userId: state.user.uid,
            characterName,
            playerName,
            deity: '',
            age: '',
            etherLevel: '1',
            potential: '',
            awakening: '',
            armor: '0',
            strength: '0',
            dexterity: '0',
            constitution: '0',
            intelligence: '0',
            wisdom: '0',
            charisma: '0',
            hpCurrent: '10',
            hpMax: '10',
            etherCurrent: '5',
            etherMax: '5',
            skills: {},
            abilities: [],
            weapons: [],
            inventory: [],
            notes: '',
            panelLayout: defaultPanels,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        defaultSkills.forEach(skill => {
            const skillId = `skill-${skill.toLowerCase().replace(/\s+/g, '-')}`;
            newSheet.skills[skillId] = '';
        });
        newSheet.abilities.push({
            name: 'Nova Habilidade',
            ether: '0',
            grade: '1',
            description: 'Descrição da habilidade...',
            type: 'Passiva',
            duration: 'Duração',
            range: 'Alcance',
            collapsed: false
        });
        newSheet.weapons.push({
            name: 'Nova Arma',
            act: '',
            damage: '',
            range: '',
            size: ''
        });
        newSheet.inventory.push({
            quantity: '1',
            name: 'Novo Item',
            description: '',
            carrying: true,
            collapsed: false
        });
        state.sheets.push(newSheet);
        saveSheets();
        closeModal(elements.newSheetModal);
        renderSheets();
        openSheet(newSheet.id);
    }

    // Abrir ficha
    function openSheet(sheetId) {
        const sheet = state.sheets.find(s => s.id === sheetId);
        if (!sheet) {
            showToast('Ficha não encontrada');
            showHub();
            return;
        }
        // Jogador só pode abrir sua ficha
        if (!state.isMaster && sheet.userId !== state.user.uid) {
            showToast('Você não tem permissão para acessar esta ficha');
            return;
        }
        state.currentSheetId = sheetId;
        loadSheetData(sheet);
        showSheet();
    }

    // Carregar dados da ficha (igual ao seu código atual, só removendo localStorage)
    function loadSheetData(sheet) {
        elements.characterName.value = sheet.characterName || '';
        elements.playerName.value = sheet.playerName || '';
        elements.deity.value = sheet.deity || '';
        elements.age.value = sheet.age || '';
        elements.etherLevel.value = sheet.etherLevel || '';
        elements.potential.value = sheet.potential || '';
        elements.awakening.value = sheet.awakening || '';
        elements.armor.value = sheet.armor || '0';
        elements.strength.value = sheet.strength || '0';
        elements.dexterity.value = sheet.dexterity || '0';
        elements.constitution.value = sheet.constitution || '0';
        elements.intelligence.value = sheet.intelligence || '0';
        elements.wisdom.value = sheet.wisdom || '0';
        elements.charisma.value = sheet.charisma || '0';
        elements.hpCurrent.value = sheet.hpCurrent || '0';
        elements.hpMax.value = sheet.hpMax || '0';
        elements.etherCurrent.value = sheet.etherCurrent || '0';
        elements.etherMax.value = sheet.etherMax || '0';
        elements.notes.value = sheet.notes || '';

        // Limpar e adicionar perícias
        createSkills(sheet.skills);

        // Limpar e adicionar habilidades
        elements.abilitiesContainer.innerHTML = '';
        if (sheet.abilities && sheet.abilities.length > 0) {
            sheet.abilities.forEach(ability => {
                addAbility(
                    ability.name, 
                    ability.ether, 
                    ability.grade, 
                    ability.description, 
                    ability.type, 
                    ability.duration, 
                    ability.range, 
                    ability.collapsed
                );
            });
        } else {
            addDefaultAbility();
        }
        
        // Limpar e adicionar armas
        elements.weaponsBody.innerHTML = '';
        if (sheet.weapons && sheet.weapons.length > 0) {
            sheet.weapons.forEach(weapon => {
                addWeapon(weapon.name, weapon.act, weapon.damage, weapon.range, weapon.size);
            });
        } else {
            addDefaultWeapon();
        }
        
        // Limpar e adicionar itens
        elements.inventoryContainer.innerHTML = '';
        if (sheet.inventory && sheet.inventory.length > 0) {
            sheet.inventory.forEach(item => {
                addItem(item.quantity, item.name, item.description, item.carrying, item.collapsed);
            });
        } else {
            addDefaultItem();
        }
        
        // Restaurar layout dos painéis
        if (sheet.panelLayout) {
            restorePanelLayout(sheet.panelLayout);
        } else {
            restorePanelLayout(defaultPanels);
        }
        
        // Atualizar cálculos
        updateCalculations();
        
        // Configurar modo de visualização para jogadores
        if (!state.isMaster) {
            document.querySelectorAll('.editable').forEach(el => {
                el.readOnly = false; // Permitir edição para o jogador
            });
            
            // Mostrar apenas botões relevantes para o jogador
            document.querySelectorAll('.action-btn').forEach(btn => {
                if (btn.id === 'back-btn' || btn.id === 'toggle-edit' || 
                    btn.id === 'apply-damage-btn' || btn.id === 'apply-real-damage-btn' || 
                    btn.id === 'apply-ether-cost-btn' || btn.id === 'add-ether-btn') {
                    btn.style.display = 'inline-flex';
                } else {
                    btn.style.display = 'none';
                }
            });
            
            // Esconder botões de deletar
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.style.display = 'none';
            });
        }
    }

    // Restaurar layout dos painéis
    function restorePanelLayout(panelLayout) {
        // Criar mapa de todos os painéis existentes
        const allPanels = {};
        document.querySelectorAll('.panel').forEach(panel => {
            allPanels[panel.dataset.panelId] = panel;
        });
        
        // Limpar colunas
        elements.column1.innerHTML = '';
        elements.column2.innerHTML = '';
        
        // Função para restaurar uma coluna
        const restoreColumn = (columnId, panelIds) => {
            const column = columnId === 'column-1' ? elements.column1 : elements.column2;
            
            panelIds.forEach(panelId => {
                if (allPanels[panelId]) {
                    column.appendChild(allPanels[panelId]);
                    delete allPanels[panelId];
                }
            });
        };
        
        // Restaurar colunas conforme o layout
        if (panelLayout['column-1']) {
            restoreColumn('column-1', panelLayout['column-1']);
        }
        
        if (panelLayout['column-2']) {
            restoreColumn('column-2', panelLayout['column-2']);
        }
        
        // Adicionar quaisquer painéis restantes na coluna 1 (fallback)
        for (const panelId in allPanels) {
            if (allPanels[panelId]) {
                elements.column1.appendChild(allPanels[panelId]);
            }
        }
    }

    // Criar perícias
    function createSkills(skillsData = {}) {
        elements.skillsContainer.innerHTML = '';
        defaultSkills.forEach(skill => {
            const skillId = `skill-${skill.toLowerCase().replace(/\s+/g, '-')}`;
            const skillValue = skillsData[skillId] || '';
            
            const skillItem = document.createElement('div');
            skillItem.className = 'skill-item';
            skillItem.innerHTML = `
                <div class="skill-name">${skill}</div>
                <input type="text" class="skill-value editable" id="${skillId}" value="${skillValue}" ${!state.isMaster ? '' : ''}>
            `;
            elements.skillsContainer.appendChild(skillItem);
        });
    }

    // Adicionar habilidade padrão
    function addDefaultAbility() {
        if (document.querySelectorAll('.ability-item').length === 0) {
            addAbility('Nova Habilidade', '0', '1', 'Descrição da habilidade...', 'Passiva', 'Duração', 'Alcance');
        }
    }

    // Adicionar habilidade/arcana
    function addAbility(name, ether, grade, description, type, duration, range, collapsed = false) {
        const abilityItem = document.createElement('div');
        abilityItem.className = `ability-item ${collapsed ? 'collapsed' : ''}`;
        abilityItem.draggable = state.isMaster;
        abilityItem.innerHTML = `
            <div class="ability-header">
                <div class="ability-name">
                    <span class="ability-toggle">${collapsed ? '+' : '-'}</span>
                    <input type="text" class="editable ability-name-input" value="${name}" placeholder="Nome da Habilidade" ${!state.isMaster ? '' : ''}>
                </div>
                <div class="ability-cost">
                    <span>Éter:</span>
                    <input type="text" class="ability-ether editable" value="${ether}" ${!state.isMaster ? '' : ''}>
                    <span>Grau:</span>
                    <input type="text" class="ability-grade editable" value="${grade}" ${!state.isMaster ? '' : ''}>
                    <button class="ability-use-btn use-ability">Usar</button>
                    ${state.isMaster ? '<button class="delete-btn delete-ability">×</button>' : ''}
                </div>
            </div>
            <textarea class="ability-desc editable" ${!state.isMaster ? '' : ''}>${description}</textarea>
            <div class="ability-meta">
                <select class="ability-type" ${!state.isMaster ? '' : ''}>
                    <option value="Passiva" ${type === 'Passiva' ? 'selected' : ''}>Passiva</option>
                    <option value="Ativa" ${type === 'Ativa' ? 'selected' : ''}>Ativa</option>
                </select>
                <input type="text" class="ability-duration" value="${duration}" placeholder="Duração" ${!state.isMaster ? '' : ''}>
                <input type="text" class="ability-range" value="${range}" placeholder="Alcance" ${!state.isMaster ? '' : ''}>
                <span class="ability-extra" id="ability-extra-${Date.now()}"></span>
            </div>
        `;
        elements.abilitiesContainer.appendChild(abilityItem);
        
        // Adicionar evento para o botão de deletar (apenas para mestre)
        if (state.isMaster) {
            const deleteBtn = abilityItem.querySelector('.delete-ability');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (confirm('Tem certeza que deseja remover esta habilidade?')) {
                        abilityItem.remove();
                        saveCurrentSheet();
                    }
                });
            }
        }
        
        // Adicionar evento para o botão de usar
        abilityItem.querySelector('.use-ability').addEventListener('click', function() {
            useAbility(abilityItem);
        });
        
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight + 20) + 'px';
        }

        // Adicionar evento para o botão de recolher/expandir
        const toggleBtn = abilityItem.querySelector('.ability-toggle');
        abilityItem.addEventListener('click', function(e) {
            if (e.target.classList.contains('ability-toggle') || e.target.closest('.ability-name')) {
                abilityItem.classList.toggle('collapsed');
                toggleBtn.textContent = abilityItem.classList.contains('collapsed') ? '+' : '-';
                
                // Ajustar altura da textarea quando expandir
                if (!abilityItem.classList.contains('collapsed')) {
                    const textarea = abilityItem.querySelector('.ability-desc');
                    setTimeout(() => {
                        adjustTextareaHeight(textarea);
                    }, 10); // Pequeno atraso para garantir que a transição tenha terminado
                }
                
                saveCurrentSheet();
            }
        });
        
        // Ajustar altura da textarea
        setTimeout(() => {
            const textarea = abilityItem.querySelector('.ability-desc');
            adjustTextareaHeight(textarea);
        }, 0);
        
        // Atualizar cálculo de éter com presença
        updateAbilityEtherCost(abilityItem);
        
        // Atualizar quando o valor de éter for alterado
        abilityItem.querySelector('.ability-ether').addEventListener('input', function() {
            updateAbilityEtherCost(abilityItem);
            saveCurrentSheet();
        });

        // Configurar arrastar e soltar para a habilidade (apenas para mestre)
        if (state.isMaster) {
            setupAbilityDragAndDrop(abilityItem);
        }
    }

    // Configurar arrastar e soltar para habilidades
    function setupAbilityDragAndDrop(abilityItem) {
        abilityItem.addEventListener('dragstart', function(e) {
            state.dragState.draggedAbility = abilityItem;
            setTimeout(() => {
                abilityItem.classList.add('dragging');
            }, 0);
            e.dataTransfer.effectAllowed = 'move';
        });

        abilityItem.addEventListener('dragend', function() {
            abilityItem.classList.remove('dragging');
            state.dragState.draggedAbility = null;
            saveCurrentSheet();
        });
    }

    // Configurar zona de soltar para habilidades
    function setupAbilitiesDropZone() {
        if (!state.isMaster) return;
        
        elements.abilitiesContainer.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const afterElement = getDragAfterAbility(e.clientY);
            const draggingAbility = state.dragState.draggedAbility;
            
            if (afterElement == null) {
                elements.abilitiesContainer.appendChild(draggingAbility);
            } else {
                elements.abilitiesContainer.insertBefore(draggingAbility, afterElement);
            }
        });
    }

    // Obter elemento após o qual a habilidade será inserida
    function getDragAfterAbility(y) {
        const abilities = [...elements.abilitiesContainer.querySelectorAll('.ability-item:not(.dragging)')];
        
        return abilities.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Atualizar custo de éter considerando presença
    function updateAbilityEtherCost(abilityItem) {
        const presenceSkill = document.getElementById('skill-presença');
        const etherInput = abilityItem.querySelector('.ability-ether');
        const extraSpan = abilityItem.querySelector('.ability-extra');
        
        if (presenceSkill && presenceSkill.value && parseInt(presenceSkill.value) > 100) {
            const presence = parseInt(presenceSkill.value);
            const etherCost = parseInt(etherInput.value) || 0;
            const calculatedCost = Math.floor(etherCost * (presence / 100));
            
            extraSpan.textContent = `Custo real: ${calculatedCost}`;
        } else {
            extraSpan.textContent = '';
        }
    }

    // Usar habilidade/arcana
    function useAbility(abilityItem) {
        const presenceSkill = document.getElementById('skill-presença');
        const etherInput = abilityItem.querySelector('.ability-ether');
        const currentEther = parseInt(elements.etherCurrent.value) || 0;
        
        let etherCost = parseInt(etherInput.value) || 0;
        
        // Calcular custo considerando presença
        if (presenceSkill && presenceSkill.value && parseInt(presenceSkill.value) > 100) {
            const presence = parseInt(presenceSkill.value);
            etherCost = Math.floor(etherCost * (presence / 100));
        }
        
        if (etherCost > currentEther) {
            alert('Éter insuficiente para usar esta habilidade!');
            return;
        }
        
        // Reduzir éter
        const newEther = Math.max(0, currentEther - etherCost);
        elements.etherCurrent.value = newEther;
        updateProgressBars();
        saveCurrentSheet();
        
        alert(`Habilidade usada! ${etherCost} de éter consumido.`);
    }

    // Adicionar arma padrão
    function addDefaultWeapon() {
        if (document.querySelectorAll('.weapon-row').length === 0) {
            addWeapon('Nova Arma', '', '', '', '');
        }
    }

    // Adicionar arma
    function addWeapon(name, act, damage, range, size) {
        const row = document.createElement('tr');
        row.className = 'weapon-row';
        row.innerHTML = `
            <td><input type="text" class="weapon-name editable" value="${name}"></td>
            <td><input type="text" class="weapon-act editable" value="${act}"></td>
            <td><input type="text" class="weapon-damage editable" value="${damage}"></td>
            <td><input type="text" class="weapon-range editable" value="${range}"></td>
            <td><input type="text" class="weapon-size editable" value="${size}"></td>
            ${state.isMaster ? '<td><button class="delete-btn delete-weapon">×</button></td>' : '<td></td>'}
        `;
        elements.weaponsBody.appendChild(row);
        
        // Adicionar evento para o botão de deletar (apenas para mestre)
        if (state.isMaster) {
            row.querySelector('.delete-weapon').addEventListener('click', function() {
                if (confirm('Tem certeza que deseja remover esta arma?')) {
                    row.remove();
                    saveCurrentSheet();
                }
            });
        }
        
        // Adicionar evento para salvar ao editar
        row.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', saveCurrentSheet);
        });
    }

    // Adicionar item padrão
    function addDefaultItem() {
        if (document.querySelectorAll('.inventory-item').length === 0) {
            addItem('1', 'Novo Item', '', true);
        }
    }

    // Adicionar item ao inventário
    function addItem(quantity, name, description, carrying, collapsed = false) {
        const item = document.createElement('div');
        item.className = `inventory-item ${collapsed ? 'collapsed' : ''}`;
        item.draggable = state.isMaster;
        item.innerHTML = `
            <div class="item-header">
                <div class="item-name">
                    <span class="item-toggle">${collapsed ? '+' : '-'}</span>
                    <input type="text" class="editable" value="${name}" placeholder="Nome do Item">
                    ${state.isMaster ? '<button class="delete-btn delete-item">×</button>' : ''}
                </div>
                <div class="item-meta">
                    <span>Qtd:</span>
                    <input type="number" class="item-quantity editable" value="${quantity}" min="1">
                    <span>Carregando:</span>
                    <input type="checkbox" class="item-carrying" ${carrying ? 'checked' : ''}>
                </div>
            </div>
            <textarea class="item-desc editable">${description}</textarea>
        `;
        elements.inventoryContainer.appendChild(item);
        
        // Adicionar evento para o botão de deletar (apenas para mestre)
        if (state.isMaster) {
            const deleteBtn = item.querySelector('.delete-item');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (confirm('Tem certeza que deseja remover este item?')) {
                        item.remove();
                        saveCurrentSheet();
                    }
                });
            }
        }
        
        // Adicionar evento para recolher/expandir
        const toggleBtn = item.querySelector('.item-toggle');
        item.addEventListener('click', function(e) {
            if (e.target.classList.contains('item-toggle') || e.target.closest('.item-name')) {
                item.classList.toggle('collapsed');
                toggleBtn.textContent = item.classList.contains('collapsed') ? '+' : '-';
                
                // Ajustar altura da textarea quando expandir
                if (!item.classList.contains('collapsed')) {
                    const textarea = item.querySelector('.item-desc');
                    setTimeout(() => {
                        adjustTextareaHeight(textarea);
                    }, 10); // Pequeno atraso para garantir que a transição tenha terminado
                }
                
                saveCurrentSheet();
            }
        });

        // Ajustar altura da textarea
        setTimeout(() => {
            const textarea = item.querySelector('.item-desc');
            adjustTextareaHeight(textarea);
        }, 0);

        // Configurar arrastar e soltar para o item (apenas para mestre)
        if (state.isMaster) {
            setupInventoryDragAndDrop(item);
        }
        
        // Adicionar eventos para salvar ao editar
        item.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('input', saveCurrentSheet);
        });
        
        item.querySelector('.item-carrying').addEventListener('change', saveCurrentSheet);
    }

    // Configurar arrastar e soltar para itens do inventário
    function setupInventoryDragAndDrop(item) {
        item.addEventListener('dragstart', function(e) {
            state.dragState.draggedItem = item;
            setTimeout(() => {
                item.classList.add('dragging');
            }, 0);
            e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', function() {
            item.classList.remove('dragging');
            state.dragState.draggedItem = null;
            saveCurrentSheet();
        });
    }

    // Configurar zona de soltar para itens do inventário
    function setupInventoryDropZone() {
        if (!state.isMaster) return;
        
        elements.inventoryContainer.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const afterElement = getDragAfterInventoryItem(e.clientY);
            const draggingItem = state.dragState.draggedItem;
            
            if (afterElement == null) {
                elements.inventoryContainer.appendChild(draggingItem);
            } else {
                elements.inventoryContainer.insertBefore(draggingItem, afterElement);
            }
        });
    }

    // Obter elemento após o qual o item será inserido no inventário
    function getDragAfterInventoryItem(y) {
        const items = [...elements.inventoryContainer.querySelectorAll('.inventory-item:not(.dragging)')];
        
        return items.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Aplicar dano (considerando constituição e armadura)
    function applyDamage() {
        const damage = parseInt(elements.damageInput.value) || 0;
        const constitution = parseInt(elements.constitution.value) || 0;
        const armor = parseInt(elements.armor.value) || 0;
        const currentHP = parseInt(elements.hpCurrent.value) || 0;
        
        // Calcular dano reduzido
        const reducedDamage = Math.max(0, damage - constitution - armor);
        const newHP = Math.max(0, currentHP - reducedDamage);
        
        elements.hpCurrent.value = newHP;
        elements.damageInput.value = '';
        updateProgressBars();
        saveCurrentSheet();
        
        alert(`Dano aplicado: ${reducedDamage} (${damage} - ${constitution + armor})`);
    }

    // Aplicar dano real (ignora defesas)
    function applyRealDamage() {
        const damage = parseInt(elements.realDamageInput.value) || 0;
        const currentHP = parseInt(elements.hpCurrent.value) || 0;
        const newHP = Math.max(0, currentHP - damage);
        
        elements.hpCurrent.value = newHP;
        elements.realDamageInput.value = '';
        updateProgressBars();
        saveCurrentSheet();
        
        alert(`Dano real aplicado: ${damage}`);
    }

    // Reduzir éter
    function reduceEther() {
        const cost = parseInt(elements.etherCostInput.value) || 0;
        const currentEther = parseInt(elements.etherCurrent.value) || 0;
        const newEther = Math.max(0, currentEther - cost);
        
        elements.etherCurrent.value = newEther;
        elements.etherCostInput.value = '';
        updateProgressBars();
        saveCurrentSheet();
        
        alert(`Éter reduzido em: ${cost}`);
    }

    // Adicionar éter
    function addEther() {
        const amount = parseInt(elements.etherCostInput.value) || 0;
        const currentEther = parseInt(elements.etherCurrent.value) || 0;
        const maxEther = parseInt(elements.etherMax.value) || 0;
        const newEther = Math.min(maxEther, currentEther + amount);
        
        elements.etherCurrent.value = newEther;
        elements.etherCostInput.value = '';
        updateProgressBars();
        saveCurrentSheet();
        
        alert(`Éter aumentado em: ${amount}`);
    }

    // Atualizar cálculos
    function updateCalculations() {
        // Calcular valores dos atributos
        updateAttributeCalculation('strength');
        updateAttributeCalculation('dexterity');
        updateAttributeCalculation('constitution');
        updateAttributeCalculation('intelligence');
        updateAttributeCalculation('wisdom');
        updateAttributeCalculation('charisma');
        
        // Atualizar barras de progresso
        updateProgressBars();
        
        // Atualizar custos de habilidades
        document.querySelectorAll('.ability-item').forEach(ability => {
            updateAbilityEtherCost(ability);
        });
    }

    // Calcular valor do atributo (1D, 2D, etc.)
    function updateAttributeCalculation(attribute) {
        const value = parseInt(elements[attribute].value) || 0;
        let calc = '';
        
        if (value <= 149) calc = '1D';
        else if (value >= 150 && value < 250) calc = '2D';
        else if (value >= 250 && value < 350) calc = '3D';
        else if (value >= 350 && value < 450) calc = '4D';
        else if (value >= 450 && value < 550) calc = '5D';
        else if (value >= 550 && value < 650) calc = '6D';
        else if (value >= 650 && value < 750) calc = '7D';
        else if (value >= 750 && value < 850) calc = '8D';
        else if (value >= 850 && value < 950) calc = '9D';
        else if (value >= 950 && value < 1050) calc = '10D';
        else calc = 'Fora da faixa';
        
        document.getElementById(`${attribute}-calc`).textContent = calc;
    }

    // Atualizar barras de progresso
    function updateProgressBars() {
        const hpCurrent = parseInt(elements.hpCurrent.value) || 0;
        const hpMax = parseInt(elements.hpMax.value) || 1;
        const hpPercent = Math.min(100, (hpCurrent / hpMax * 100)).toFixed(1);
        elements.hpBar.style.width = hpPercent + '%';
        elements.hpBar.textContent = hpPercent + '%';
        
        const etherCurrent = parseInt(elements.etherCurrent.value) || 0;
        const etherMax = parseInt(elements.etherMax.value) || 1;
        const etherPercent = Math.min(100, (etherCurrent / etherMax * 100)).toFixed(1);
        elements.etherBar.style.width = etherPercent + '%';
        elements.etherBar.textContent = etherPercent + '%';
    }

    // Alternar modo de edição (apenas para mestre)
    function toggleEditMode() {
        if (!state.isMaster) return;
        
        state.dragState.isEditMode = !state.dragState.isEditMode;
        
        if (state.dragState.isEditMode) {
            // Ativar modo de edição
            elements.toggleEditBtn.textContent = 'Salvar Layout';
            document.querySelectorAll('.panel').forEach(panel => {
                panel.style.cursor = 'grab';
                panel.draggable = true;
            });
            document.querySelectorAll('.drag-handle').forEach(handle => {
                handle.style.display = 'block';
            });
        } else {
            // Desativar modo de edição
            elements.toggleEditBtn.textContent = 'Modo Reorganizar';
            document.querySelectorAll('.panel').forEach(panel => {
                panel.style.cursor = '';
                panel.classList.remove('dragging');
                panel.draggable = false;
            });
            document.querySelectorAll('.drag-handle').forEach(handle => {
                handle.style.display = 'none';
            });
            saveCurrentSheet();
        }
    }

    // Iniciar arrastar painel (apenas para mestre)
    function startDrag(e) {
        if (!state.dragState.isEditMode || !state.isMaster) return;
        
        const panel = e.target.closest('.panel');
        if (!panel) return;
        
        state.dragState.isDragging = true;
        state.dragState.draggedPanel = panel;
        state.dragState.draggedColumn = panel.parentElement;
        state.dragState.draggedIndex = Array.from(panel.parentElement.children).indexOf(panel);
        
        panel.classList.add('dragging');
        e.dataTransfer.setData('text/plain', panel.dataset.panelId);
        e.dataTransfer.effectAllowed = 'move';
    }

    // Durante o arrastar (apenas para mestre)
    function dragOver(e) {
        if (!state.dragState.isDragging || !state.dragState.isEditMode || !state.isMaster) return;
        
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        const column = e.target.closest('.grid-column');
        if (!column) return;
        
        const panels = Array.from(column.children).filter(el => el.classList.contains('panel') && el !== state.dragState.draggedPanel);
        const afterElement = getDragAfterElement(column, e.clientY);
        
        // Mostrar indicador de posição
        const dropIndicator = column.querySelector('.drop-indicator') || document.createElement('div');
        dropIndicator.className = 'drop-indicator active';
        
        if (afterElement) {
            column.insertBefore(dropIndicator, afterElement);
        } else {
            column.appendChild(dropIndicator);
        }
    }

    // Obter elemento após o qual o painel será inserido
    function getDragAfterElement(column, y) {
        const panels = Array.from(column.children).filter(el => el.classList.contains('panel') && el !== state.dragState.draggedPanel);
        
        return panels.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Finalizar arrastar (apenas para mestre)
    function endDrag(e) {
        if (!state.dragState.isDragging || !state.dragState.isEditMode || !state.isMaster) return;
        
        e.preventDefault();
        
        const column = e.target.closest('.grid-column');
        if (column) {
            const afterElement = getDragAfterElement(column, e.clientY);
            const dropIndicator = column.querySelector('.drop-indicator');
            
            if (dropIndicator) {
                if (afterElement) {
                    column.insertBefore(state.dragState.draggedPanel, afterElement);
                } else {
                    column.appendChild(state.dragState.draggedPanel);
                }
                
                dropIndicator.remove();
            }
        }
        
        // Limpar estado
        state.dragState.draggedPanel.classList.remove('dragging');
        state.dragState.isDragging = false;
        state.dragState.draggedPanel = null;
        state.dragState.draggedColumn = null;
        state.dragState.draggedIndex = -1;
        saveCurrentSheet();
    }

    // Salvar ficha atual
    function saveCurrentSheet() {
        if (!state.currentSheetId) return;
        
        const sheet = state.sheets.find(s => s.id === state.currentSheetId);
        if (!sheet) return;
        
        // Atualizar dados básicos
        sheet.characterName = elements.characterName.value;
        sheet.playerName = elements.playerName.value;
        sheet.deity = elements.deity.value;
        sheet.age = elements.age.value;
        sheet.etherLevel = elements.etherLevel.value;
        sheet.potential = elements.potential.value;
        sheet.awakening = elements.awakening.value;
        sheet.armor = elements.armor.value;
        sheet.strength = elements.strength.value;
        sheet.dexterity = elements.dexterity.value;
        sheet.constitution = elements.constitution.value;
        sheet.intelligence = elements.intelligence.value;
        sheet.wisdom = elements.wisdom.value;
        sheet.charisma = elements.charisma.value;
        sheet.hpCurrent = elements.hpCurrent.value;
        sheet.hpMax = elements.hpMax.value;
        sheet.etherCurrent = elements.etherCurrent.value;
        sheet.etherMax = elements.etherMax.value;
        sheet.notes = elements.notes.value;
        sheet.updatedAt = new Date().toISOString();
        
        // Atualizar layout dos painéis
        sheet.panelLayout = getCurrentPanelLayout();
        
        // Atualizar habilidades
        sheet.abilities = [];
        document.querySelectorAll('.ability-item').forEach(ability => {
            sheet.abilities.push({
                name: ability.querySelector('.ability-name-input').value,
                ether: ability.querySelector('.ability-ether').value,
                grade: ability.querySelector('.ability-grade').value,
                description: ability.querySelector('.ability-desc').value,
                type: ability.querySelector('.ability-type').value,
                duration: ability.querySelector('.ability-duration').value,
                range: ability.querySelector('.ability-range').value,
                collapsed: ability.classList.contains('collapsed')
            });
        });
        
        // Atualizar armas
        sheet.weapons = [];
        document.querySelectorAll('.weapon-row').forEach(weapon => {
            sheet.weapons.push({
                name: weapon.querySelector('.weapon-name').value,
                act: weapon.querySelector('.weapon-act').value,
                damage: weapon.querySelector('.weapon-damage').value,
                range: weapon.querySelector('.weapon-range').value,
                size: weapon.querySelector('.weapon-size').value
            });
        });
        
        // Atualizar inventário
        sheet.inventory = [];
        document.querySelectorAll('.inventory-item').forEach(item => {
            sheet.inventory.push({
                quantity: item.querySelector('.item-quantity').value,
                name: item.querySelector('.item-name input').value,
                description: item.querySelector('.item-desc').value,
                carrying: item.querySelector('.item-carrying').checked,
                collapsed: item.classList.contains('collapsed')
            });
        });
        
        // Atualizar perícias
        sheet.skills = {};
        defaultSkills.forEach(skill => {
            const skillId = `skill-${skill.toLowerCase().replace(/\s+/g, '-')}`;
            const skillInput = document.getElementById(skillId);
            if (skillInput) {
                sheet.skills[skillId] = skillInput.value;
            }
        });
        
        saveSheets();
    }

    // Obter layout atual dos painéis
    function getCurrentPanelLayout() {
        return {
            'column-1': Array.from(elements.column1.children)
                .filter(el => el.classList.contains('panel'))
                .map(panel => panel.dataset.panelId),
            'column-2': Array.from(elements.column2.children)
                .filter(el => el.classList.contains('panel'))
                .map(panel => panel.dataset.panelId)
        };
    }

    // Salvar fichas no armazenamento local
    function saveSheets() {
        localStorage.setItem('rpgSheets', JSON.stringify(state.sheets));
    }

    // Excluir ficha (apenas para mestre)
    function deleteSheet(sheetId) {
        if (!state.isMaster) return;
        
        if (!confirm('Tem certeza que deseja excluir esta ficha? Esta ação não pode ser desfeita.')) {
            return;
        }
        
        state.sheets = state.sheets.filter(sheet => sheet.id !== sheetId);
        saveSheets();
        renderSheets();
        showToast('Ficha excluída com sucesso');
        
        // Se estivermos visualizando a ficha que foi excluída, voltar ao hub
        if (state.currentSheetId === sheetId) {
            showHub();
        }
    }

    // Mostrar hub
    function showHub() {
        elements.hubView.style.display = 'block';
        elements.sheetView.style.display = 'none';
        loadSheets();
    }

    // Mostrar ficha
    function showSheet() {
        elements.hubView.style.display = 'none';
        elements.sheetView.style.display = 'block';
    }

    // Mostrar notificação toast
    function showToast(message, duration = 3000) {
        elements.toast.textContent = message;
        elements.toast.classList.add('show');
        setTimeout(() => elements.toast.classList.remove('show'), duration);
    }

    // Fechar modal
    function closeModal(modal) {
        modal.style.display = 'none';
    }

    // Configurar event listeners
    function setupEventListeners() {
        elements.newSheetBtn.addEventListener('click', () => {
            elements.newSheetName.value = '';
            elements.newSheetPlayer.value = '';
            openModal(elements.newSheetModal);
        });
        elements.createSheetBtn.addEventListener('click', createNewSheet);
        elements.cancelSheetBtn.addEventListener('click', () => closeModal(elements.newSheetModal));
        elements.refreshBtn.addEventListener('click', () => {
            loadSheets();
            showToast('Fichas atualizadas');
        });
        elements.searchBtn.addEventListener('click', () => {
            renderSheets(elements.searchInput.value.trim());
        });
        elements.searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') renderSheets(elements.searchInput.value.trim());
        });
        elements.sheetsContainer.addEventListener('click', (e) => {
            const sheetCard = e.target.closest('.sheet-card');
            if (!sheetCard) return;
            const sheetId = sheetCard.dataset.sheetId;
            const action = e.target.dataset.action;
            if (!action) return;
            switch (action) {
                case 'edit':
                    openSheet(sheetId);
                    break;
                case 'delete':
                    if (state.isMaster) deleteSheet(sheetId);
                    break;
            }
        });
        elements.backBtn.addEventListener('click', showHub);
        // ...adicione os outros listeners do seu código...
    }

    // Inicializar
    init();
});
</script>
